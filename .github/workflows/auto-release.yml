name: Auto Release on Version Change

on:
  push:
    branches: [main]
    paths:
      - "crates/types/Cargo.toml"
      - "crates/client/Cargo.toml"
      - "crates/core/Cargo.toml"
      - "crates/py/Cargo.toml"
      - "crates/server/Cargo.toml"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

permissions:
  contents: read

jobs:
  # ---------------- STAGE 1: DETECT ----------------
  detect-changes:
    name: Detect Version Changes
    runs-on: ubuntu-latest
    outputs:
      types-changed: ${{ steps.check-types.outputs.changed }}
      core-changed: ${{ steps.check-core.outputs.changed }}
      python-changed: ${{ steps.check-python.outputs.changed }}
      server-changed: ${{ steps.check-server.outputs.changed }}
      types-version: ${{ steps.check-types.outputs.version }}
      core-version: ${{ steps.check-core.outputs.version }}
      python-version: ${{ steps.check-python.outputs.version }}
      server-version: ${{ steps.check-server.outputs.version }}
      types-previous: ${{ steps.check-types.outputs.previous }}
      client-changed: ${{ steps.check-client.outputs.changed }}
      client-version: ${{ steps.check-client.outputs.version }}
      client-previous: ${{ steps.check-client.outputs.previous }}
      core-previous: ${{ steps.check-core.outputs.previous }}
      python-previous: ${{ steps.check-python.outputs.previous }}
      server-previous: ${{ steps.check-server.outputs.previous }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check spatio-types version changes
        id: check-types
        run: |
          CURRENT_VERSION=$(awk -F'[" ]+' '/^version[[:space:]]*=/ {print $3; exit}' crates/types/Cargo.toml)
          TAG_NAME="types-v$CURRENT_VERSION"
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME$"; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
          PREVIOUS_COMMIT=$(git log --format=format:%H --follow -2 crates/types/Cargo.toml | tail -1)
          if [ -n "$PREVIOUS_COMMIT" ]; then
            PREVIOUS_VERSION=$(git show $PREVIOUS_COMMIT:crates/types/Cargo.toml | awk -F'[" ]+' '/^version[[:space:]]*=/ {print $3; exit}' || echo "")
          else
            PREVIOUS_VERSION=""
          fi
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "previous=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT

      - name: Check spatio-client version changes
        id: check-client
        run: |
          CURRENT_VERSION=$(awk -F'[" ]+' '/^version[[:space:]]*=/ {print $3; exit}' crates/client/Cargo.toml)
          TAG_NAME="client-v$CURRENT_VERSION"
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME$"; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
          PREVIOUS_COMMIT=$(git log --format=format:%H --follow -2 crates/client/Cargo.toml | tail -1)
          if [ -n "$PREVIOUS_COMMIT" ]; then
            PREVIOUS_VERSION=$(git show $PREVIOUS_COMMIT:crates/client/Cargo.toml | awk -F'[" ]+' '/^version[[:space:]]*=/ {print $3; exit}' || echo "")
          else
            PREVIOUS_VERSION=""
          fi
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "previous=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT

      - name: Check spatio core version changes
        id: check-core
        run: |
          CURRENT_VERSION=$(awk -F'[" ]+' '/^version[[:space:]]*=/ {print $3; exit}' crates/core/Cargo.toml)
          TAG_NAME="core-v$CURRENT_VERSION"
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME$"; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
          PREVIOUS_COMMIT=$(git log --format=format:%H --follow -2 crates/core/Cargo.toml | tail -1)
          if [ -n "$PREVIOUS_COMMIT" ]; then
            PREVIOUS_VERSION=$(git show $PREVIOUS_COMMIT:crates/core/Cargo.toml | awk -F'[" ]+' '/^version[[:space:]]*=/ {print $3; exit}' || echo "")
          else
            PREVIOUS_VERSION=""
          fi
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "previous=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT

      - name: Check Python version changes
        id: check-python
        run: |
          CURRENT_VERSION=$(awk -F'[" ]+' '/^version[[:space:]]*=/ {print $3; exit}' crates/py/Cargo.toml)
          TAG_NAME="python-v$CURRENT_VERSION"
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME$"; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
          PREVIOUS_COMMIT=$(git log --format=format:%H --follow -2 crates/py/Cargo.toml | tail -1)
          if [ -n "$PREVIOUS_COMMIT" ]; then
            PREVIOUS_VERSION=$(git show $PREVIOUS_COMMIT:crates/py/Cargo.toml | awk -F'[" ]+' '/^version[[:space:]]*=/ {print $3; exit}' || echo "")
          else
            PREVIOUS_VERSION=""
          fi
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "previous=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT

      - name: Check spatio server version changes
        id: check-server
        run: |
          CURRENT_VERSION=$(awk -F'[" ]+' '/^version[[:space:]]*=/ {print $3; exit}' crates/server/Cargo.toml)
          TAG_NAME="server-v$CURRENT_VERSION"
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME$"; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
          PREVIOUS_COMMIT=$(git log --format=format:%H --follow -2 crates/server/Cargo.toml | tail -1)
          if [ -n "$PREVIOUS_COMMIT" ]; then
            PREVIOUS_VERSION=$(git show $PREVIOUS_COMMIT:crates/server/Cargo.toml | awk -F'[" ]+' '/^version[[:space:]]*=/ {print $3; exit}' || echo "")
          else
            PREVIOUS_VERSION=""
          fi
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "previous=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "### Version Detection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Crate | Previous | Current | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|----------|---------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| spatio-types | ${{ steps.check-types.outputs.previous }} | ${{ steps.check-types.outputs.version }} | ${{ steps.check-types.outputs.changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| spatio-client | ${{ steps.check-client.outputs.previous }} | ${{ steps.check-client.outputs.version }} | ${{ steps.check-client.outputs.changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| spatio | ${{ steps.check-core.outputs.previous }} | ${{ steps.check-core.outputs.version }} | ${{ steps.check-core.outputs.changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| spatio-py | ${{ steps.check-python.outputs.previous }} | ${{ steps.check-python.outputs.version }} | ${{ steps.check-python.outputs.changed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| spatio-server | ${{ steps.check-server.outputs.previous }} | ${{ steps.check-server.outputs.version }} | ${{ steps.check-server.outputs.changed }} |" >> $GITHUB_STEP_SUMMARY

  # ---------------- STAGE 2: TEST ----------------
  test-types:
    name: Test spatio-types (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: detect-changes
    if: needs.detect-changes.outputs.types-changed == 'true'
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-types-${{ hashFiles('**/Cargo.lock') }}

      - run: cargo fmt --all -- --check
        if: matrix.os == 'ubuntu-latest'
      - run: cargo clippy -p spatio-types --all-targets --all-features -- -D warnings
        if: matrix.os == 'ubuntu-latest'
      - run: cargo build -p spatio-types --all-features --verbose
      - run: cargo test -p spatio-types --all-features --verbose
      - run: cargo test -p spatio-types --doc
      - run: cd crates/types && cargo package --allow-dirty
        if: matrix.os == 'ubuntu-latest'

  test-client:
    name: Test spatio-client (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: detect-changes
    if: needs.detect-changes.outputs.client-changed == 'true'
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-client-${{ hashFiles('**/Cargo.lock') }}

      - run: cargo fmt --all -- --check
        if: matrix.os == 'ubuntu-latest'
      - run: cargo clippy -p spatio-client --all-targets --all-features -- -D warnings
        if: matrix.os == 'ubuntu-latest'
      - run: cargo build -p spatio-client --all-features --verbose
      - run: cargo test -p spatio-client --all-features --verbose
      - run: cargo test -p spatio-client --doc

  test-core:
    name: Test spatio core (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: detect-changes
    if: needs.detect-changes.outputs.core-changed == 'true'
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-core-${{ hashFiles('**/Cargo.lock') }}

      - run: cargo fmt --all -- --check
        if: matrix.os == 'ubuntu-latest'
      - run: cargo clippy -p spatio --all-targets --all-features -- -D warnings
        if: matrix.os == 'ubuntu-latest'
      - run: cargo build -p spatio --all-features --verbose
      - run: cargo test -p spatio --all-features --verbose
      - run: cargo test -p spatio --doc

  test-server:
    name: Test spatio server (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: detect-changes
    if: needs.detect-changes.outputs.server-changed == 'true'
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-server-${{ hashFiles('**/Cargo.lock') }}

      - run: cargo fmt --all -- --check
        if: matrix.os == 'ubuntu-latest'
      - run: cargo clippy -p spatio-server --all-targets --all-features -- -D warnings
        if: matrix.os == 'ubuntu-latest'
      - run: cargo build -p spatio-server --all-features --verbose
      - run: cargo test -p spatio-server --all-features --verbose
      - run: cargo test -p spatio-server --doc

  test-python:
    name: Test Python (${{ matrix.os }}, py${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    needs: detect-changes
    if: needs.detect-changes.outputs.python-changed == 'true'
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13"]
        exclude:
          - os: macos-latest
            python-version: "3.9"
          - os: macos-latest
            python-version: "3.10"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        working-directory: crates/py
        run: |
          python -m pip install --upgrade pip
          pip install setuptools maturin pytest -r requirements-dev.txt

      - name: Build wheel
        working-directory: crates/py
        env:
          PYO3_USE_ABI3_FORWARD_COMPATIBILITY: 1
        run: maturin build --release --out dist --interpreter python

      - name: Install wheel
        working-directory: crates/py
        shell: bash
        run: |
          WHEEL=$(find dist -name "*.whl" | head -n 1)
          python -m pip install "$WHEEL" --force-reinstall --no-deps

      - name: Run tests
        run: pytest crates/py/tests -v --tb=short -x --maxfail=5

  # ---------------- STAGE 3: RELEASE ----------------
  release-types:
    name: Release spatio-types
    runs-on: ubuntu-latest
    needs: [test-types, detect-changes]
    if: needs.detect-changes.outputs.types-changed == 'true' && needs.test-types.result == 'success'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dtolnay/rust-toolchain@stable

      - name: Publish spatio-types to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: |
          cd crates/types
          cargo publish --token "$CARGO_REGISTRY_TOKEN"

      - name: Tag and release
        run: |
          VERSION="${{ needs.detect-changes.outputs.types-version }}"
          TAG="types-v$VERSION"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag "$TAG" -m "Release spatio-types $VERSION"
          git push origin "$TAG"

  release-client:
    name: Release spatio-client
    runs-on: ubuntu-latest
    needs: [test-client, detect-changes, release-server]
    if: |
      always() &&
      needs.detect-changes.outputs.client-changed == 'true' &&
      needs.test-client.result == 'success' &&
      (needs.release-server.result == 'success' || needs.release-server.result == 'skipped')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dtolnay/rust-toolchain@stable

      - name: Wait for spatio-server to be available on crates.io
        if: needs.release-server.result == 'success'
        run: |
          VERSION="${{ needs.detect-changes.outputs.server-version }}"
          MAX_ATTEMPTS=10
          ATTEMPT=1
          SLEEP_TIME=5

          echo "Waiting for spatio-server v$VERSION to be available on crates.io..."

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS (waiting ${SLEEP_TIME}s)"
            sleep $SLEEP_TIME

            if curl -sf "https://crates.io/api/v1/crates/spatio-server" | grep -q "\"num\":\"$VERSION\""; then
              echo "✓ spatio-server v$VERSION is now available on crates.io"
              exit 0
            fi

            ATTEMPT=$((ATTEMPT + 1))
            SLEEP_TIME=$((SLEEP_TIME * 2))
            if [ $SLEEP_TIME -gt 60 ]; then
              SLEEP_TIME=60
            fi
          done
          exit 0

      - name: Publish spatio-client to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: |
          cd crates/client
          cargo publish --token "$CARGO_REGISTRY_TOKEN"

      - name: Tag and release
        run: |
          VERSION="${{ needs.detect-changes.outputs.client-version }}"
          TAG="client-v$VERSION"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag "$TAG" -m "Release spatio-client $VERSION"
          git push origin "$TAG"

  release-core:
    name: Release spatio core
    runs-on: ubuntu-latest
    needs: [test-core, detect-changes, release-types]
    if: |
      always() &&
      needs.detect-changes.outputs.core-changed == 'true' &&
      needs.test-core.result == 'success' &&
      (needs.release-types.result == 'success' || needs.release-types.result == 'skipped') &&
      needs.release-types.result != 'failure'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dtolnay/rust-toolchain@stable

      - name: Wait for spatio-types to be available on crates.io
        if: needs.release-types.result == 'success'
        run: |
          VERSION="${{ needs.detect-changes.outputs.types-version }}"
          MAX_ATTEMPTS=10
          ATTEMPT=1
          SLEEP_TIME=5

          echo "Waiting for spatio-types v$VERSION to be available on crates.io..."

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS (waiting ${SLEEP_TIME}s)"
            sleep $SLEEP_TIME

            # Check if the version is available on crates.io
            if curl -sf "https://crates.io/api/v1/crates/spatio-types" | grep -q "\"num\":\"$VERSION\""; then
              echo "✓ spatio-types v$VERSION is now available on crates.io"
              exit 0
            fi

            ATTEMPT=$((ATTEMPT + 1))
            # Exponential backoff: 5s, 10s, 20s, 40s, 60s (capped at 60s)
            SLEEP_TIME=$((SLEEP_TIME * 2))
            if [ $SLEEP_TIME -gt 60 ]; then
              SLEEP_TIME=60
            fi
          done

          echo "Warning: spatio-types v$VERSION not confirmed on crates.io after $MAX_ATTEMPTS attempts"
          echo "Proceeding anyway - cargo publish will fail if dependency is not available"
          exit 0

      - name: Publish spatio to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: |
          cd crates/core
          cargo publish --token "$CARGO_REGISTRY_TOKEN"

      - name: Tag and release
        run: |
          VERSION="${{ needs.detect-changes.outputs.core-version }}"
          TAG="core-v$VERSION"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag "$TAG" -m "Release spatio $VERSION"
          git push origin "$TAG"

  release-server:
    name: Release spatio server
    runs-on: ubuntu-latest
    needs: [test-server, detect-changes, release-types]
    if: |
      always() &&
      needs.detect-changes.outputs.server-changed == 'true' &&
      needs.test-server.result == 'success' &&
      (needs.release-types.result == 'success' || needs.release-types.result == 'skipped') &&
      needs.release-types.result != 'failure'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dtolnay/rust-toolchain@stable

      - name: Wait for spatio-types to be available on crates.io
        if: needs.release-types.result == 'success'
        run: |
          VERSION="${{ needs.detect-changes.outputs.types-version }}"
          MAX_ATTEMPTS=10
          ATTEMPT=1
          SLEEP_TIME=5

          echo "Waiting for spatio-types v$VERSION to be available on crates.io..."

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS (waiting ${SLEEP_TIME}s)"
            sleep $SLEEP_TIME

            if curl -sf "https://crates.io/api/v1/crates/spatio-types" | grep -q "\"num\":\"$VERSION\""; then
              echo "✓ spatio-types v$VERSION is now available on crates.io"
              exit 0
            fi

            ATTEMPT=$((ATTEMPT + 1))
            SLEEP_TIME=$((SLEEP_TIME * 2))
            if [ $SLEEP_TIME -gt 60 ]; then
              SLEEP_TIME=60
            fi
          done
          exit 0

      - name: Publish spatio-server to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: |
          cd crates/server
          cargo publish --token "$CARGO_REGISTRY_TOKEN"

      - name: Tag and release
        run: |
          VERSION="${{ needs.detect-changes.outputs.server-version }}"
          TAG="server-v$VERSION"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag "$TAG" -m "Release spatio-server $VERSION"
          git push origin "$TAG"

  build-and-push-docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [test-server, detect-changes]
    if: |
      always() &&
      needs.detect-changes.outputs.server-changed == 'true' &&
      needs.test-server.result == 'success'
    permissions:
      contents: read
      packages: write
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }}-server
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ needs.detect-changes.outputs.server-version }}
            type=sha,prefix=

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: crates/server/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  build-python-artifacts:
    name: Build Python Wheels (${{ matrix.os }}, py${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    needs: [test-python, detect-changes]
    if: needs.detect-changes.outputs.python-changed == 'true' && needs.test-python.result == 'success'
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - uses: dtolnay/rust-toolchain@stable
      - run: pip install maturin
      - run: |
          maturin build --release --out dist --interpreter python
        working-directory: crates/py
        env:
          PYO3_USE_ABI3_FORWARD_COMPATIBILITY: 1
      - uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.os }}-py${{ matrix.python-version }}
          path: crates/py/dist/*.whl

  publish-to-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [build-python-artifacts, detect-changes]
    if: needs.detect-changes.outputs.python-changed == 'true'
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: wheel-*
          merge-multiple: true
      - uses: dtolnay/rust-toolchain@stable

      - name: Publish to PyPI
        run: |
          python -m pip install --upgrade pip
          pip install "packaging>=24.1" twine
          twine check dist/*
          twine upload dist/*.whl --non-interactive

      - name: Tag and release
        run: |
          VERSION="${{ needs.detect-changes.outputs.python-version }}"
          TAG="python-v$VERSION"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag "$TAG" -m "Release spatio-py $VERSION"
          git push origin "$TAG"

  # ---------------- STAGE 4: DOCS ----------------
  docs:
    name: Build and Deploy Docs
    runs-on: ubuntu-latest
    needs: [release-core, detect-changes]
    if: |
      always() &&
      needs.detect-changes.outputs.core-changed == 'true' &&
      (needs.release-core.result == 'success' || needs.release-core.result == 'skipped')
    permissions:
      contents: read
      pages: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: |
          cargo doc -p spatio -p spatio-types --no-deps --all-features
          echo '<meta http-equiv="refresh" content="0; url=spatio">' > target/doc/index.html
      - uses: actions/configure-pages@v4
      - uses: actions/upload-pages-artifact@v3
        with:
          path: target/doc
      - uses: actions/deploy-pages@v4

  # ---------------- STAGE 5: SUMMARY ----------------
  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, release-types, release-client, release-core, release-server, publish-to-pypi, build-and-push-docker]
    if: always()
    steps:
      - run: |
          echo "### Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Crate | Version | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| spatio-types | ${{ needs.detect-changes.outputs.types-version }} | ${{ needs.release-types.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| spatio-client | ${{ needs.detect-changes.outputs.client-version }} | ${{ needs.release-client.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| spatio | ${{ needs.detect-changes.outputs.core-version }} | ${{ needs.release-core.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| spatio-py | ${{ needs.detect-changes.outputs.python-version }} | ${{ needs.publish-to-pypi.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| spatio-server | ${{ needs.detect-changes.outputs.server-version }} | ${{ needs.release-server.result }} |" >> $GITHUB_STEP_SUMMARY
